---
title: "Fit Tools"
output:
  flexdashboard::flex_dashboard:
    orientation: rows
    vertical_layout: fill
    theme: yeti
---

<!-- “default”, “cerulean”, “journal”, “flatly”, “darkly”, “readable”, “spacelab”, “united”, “cosmo”, “lumen”, “paper”, “sandstone”, “simplex”, “yeti” -->


```{r setup, include=FALSE}
library(flexdashboard)
library(ggplot2)
library(plotly)
library(tidyr)
library(dplyr)
require(scales)
library(knitr)
library(kableExtra)
library(RColorBrewer)

```

```{r processing, include=FALSE}

#fit_table = read.table("c:/Users/nea040/Desktop/c935099c-913d-4a78-8a39-4360510e437c/matt_summarised_data/output_170120.csv", sep=",", header=T)

fit_table = read.table("././example_files/Activities.csv", sep=",", header=T)

fit_table$Date <- as.POSIXct(fit_table$Date)
fit_table$Month <- format(fit_table$Date, "%m")
fit_table$Day <- as.numeric(format(fit_table$Date, "%j"))
fit_table$Year <- format(fit_table$Date, "%Y")

today <- as.POSIXct(Sys.Date())
today_Day_Month <- format(today, "%b %d")
today_Day <- as.numeric(format(today, "%j"))

run_table <- subset(fit_table, Activity.Type=="Running")
bike_table <- subset(fit_table, Activity.Type=="Cycling")

# set out consistent colors

#display.brewer.pal(n = 3, name = 'Dark2')
#brewer.pal(n = 3, name = 'Set2')

year_cols <- c("2018" = "#66C2A5", "2019" = "#FC8D62", "2020" = "#8DA0CB")

#brewer.pal(n = 3, name = 'Dark2')

activity_cols <- c("Running" = "#1B9E77", "Cycling" = "#D95F02", "Walking" = "#7570B3")

# the date contains lots of gaps when I didn't do anything
# want to fill these so it will plot better
# first create a timeseries encompassing the entiure datetimes
#ts = seq.POSIXt(min(as.POSIXct(fit_table$local_date, '%Y')), max(as.POSIXct(fit_table$local_date, '%Y')), by='day')

#df <- data.frame(local_date=ts)

# now join and force the dates to align
#fit_table <- full_join(df, fit_table)

# fill NAs with 0s

#fit_table <- fit_table %>% 
#  group_by(local_date) %>% 
#  mutate_each(funs(ifelse(is.na(.),0,.)))

```

Activities
=====================================  


Row {data-height=200}
-----------------------------------------------------------------------

### Cumulative Running Distance

```{r}

p <- run_table %>%
  group_by(Year) %>%
  arrange(Day) %>%
  mutate(Cumulative_Distance = cumsum(Distance)) %>%
  ggplot(., aes(x = Day, color=Year)) +
    geom_line(aes(y = Cumulative_Distance)) +
    scale_color_manual(values = year_cols) +
    theme_minimal() +
    theme(legend.title = element_blank())

ggplotly(p)

```

### Running Distance at: `r today_Day_Month`

```{r}

p <- run_table %>%
  filter(Day < today_Day) %>%
  group_by(Year) %>%
  summarise(dist = sum(Distance)) %>%
  ggplot(., aes(x=Year, y=dist, color=Year)) +
    geom_point(size=2, alpha=0.7, shape=21, stroke=2) +
    geom_segment(aes(x=Year, xend=Year, y=0, yend=dist )) +
    ylab("Distance (km)") +
    scale_color_manual(values = year_cols) +
    coord_flip() +
    theme_minimal() +
    theme(legend.title = element_blank())
  
ggplotly(p)

```

### Distance this month

```{r}

```


Row {data-height=150}
-----------------------------------------------------------------------

### All activities

```{r dpi=300}

plot_mapping <- function(fit_table) {

  cols <- c("mRNA_reads" = "#7CAE00", "rRNA_LSU" = "#C77CFF", "rRNA_SSU" = "#00BFC4")

  p <- ggplot(fit_table, aes(x=Date, y=Distance, color=Activity.Type)) +
    geom_point(alpha=0.75) +
    ylab("Distance (km)") +
    xlab("Date") +
    scale_x_datetime(labels = date_format("%b-%Y")) +
    scale_y_continuous(labels = comma) +
    scale_color_manual(values = activity_cols) +
    #facet_wrap(~Activity.Type, ncol=1) +
    theme_bw() +
    theme(legend.title = element_blank())

  return(p)

}

act_tab <- subset(fit_table, Activity.Type!="Other")

p <- plot_mapping(act_tab)

ggplotly(p)

```


Row {data-height=150}
-----------------------------------------------------------------------

### Average speed


Row {data-height=150}
-----------------------------------------------------------------------

### Average heartrate




Raw Table
=====================================  

```{r}

fit_table %>%#
  kable() %>%
  kable_styling(fixed_thead=T, bootstrap_options = c("striped", "hover", "condensed", "responsive"))
```

